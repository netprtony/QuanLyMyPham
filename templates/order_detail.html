{% extends "layout.html" %}
{% block title %}
    Chỉnh Sửa Đơn Hàng - {{ order['order_id'] }}
{% endblock %}
{% block content %}
<div class="order-detail">
    <h2>Chỉnh Sửa Đơn Hàng - {{ order['order_id'] }}</h2>
    
    <form action="{{ url_for('order_bp.update_order', order_id=order['order_id']) }}" method="POST">
        
        <h3>Thông Tin Khách Hàng</h3>
        <p><strong>Tên:</strong> {{ customer['name'] }}</p>
        <p><strong>Email:</strong> {{ customer['email'] }}</p>
        <p><strong>Số Điện Thoại:</strong> {{ customer['phone'] }}</p>
        <h3>Địa Điểm Giao Hàng</h3>
        <div class="form-group">
            <label for="delivery_location">Địa Điểm Giao Hàng:</label>
            <select id="delivery_location" name="delivery_location_id" required>
                {% for location in delivery_locations %}
                    <option value="{{ location['location_id'] }}" {% if location['location_id'] == order['delivery_location_id'] %}selected{% endif %}>
                        {{ location['address'] }} - {{ location['city'] }} - {{ location['postal_code'] }} ({{ location['type'] }})
                    </option>
                {% endfor %}
            </select>
        </div>
        
        <h3>Chi Tiết Sản Phẩm</h3>
        <table class="table">
            <thead>
                <tr>
                    <th>Tên Sản Phẩm</th>
                    <th>Danh Mục</th>
                    <th>Số Lượng</th>
                    <th>Giá</th>
                    <th>Thành Tiền</th>
                    <th>Hành Động</th>
                </tr>
            </thead>
            <tbody id="product-rows">
                {% for product in order['products_ordered'] %}
                <tr>
                    <td><input type="text" name="product_name_{{ loop.index }}" value="{{ product['product_name'] }}" required></td>
                    <td><input type="text" name="product_category_{{ loop.index }}" value="{{ product['category'] }}" required></td>
                    <td>
                        <input type="number" name="product_quantity_{{ loop.index }}" value="{{ product['quantity'] }}" required onchange="updateProductRow(this)">
                    </td>
                    <td>
                        <input type="number" name="product_price_{{ loop.index }}" value="{{ product['price'] }}" required readonly>
                    </td>
                    <td>
                        <input type="number" name="product_total_{{ loop.index }}" value="{{ product['quantity'] * product['price'] }}" required readonly>
                    </td>
                    <td>
                        <button type="button" onclick="removeProductRow(this)">Xóa</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <h3>Tổng Giá: <input type="number" id="total_price" name="total_price" value="{{ order['total_price'] }}" required readonly></h3>
        <p><strong>Ngày Đặt:</strong> <input type="date" name="order_date" value="{{ order['order_date'] }}" required></p>
        <p><strong>Trạng Thái:</strong> 
            <select name="order_status">
                <option value="Pending" {% if order['status'] == 'Pending' %}selected{% endif %}>Chờ Xử Lý</option>
                <option value="Delivered" {% if order['status'] == 'Delivered' %}selected{% endif %}>Đã Giao</option>
                <option value="Cancelled" {% if order['status'] == 'Cancelled' %}selected{% endif %}>Đã Hủy</option>
            </select>
        </p>

        <div class="actions">
            <button type="submit" class="btn btn-primary">Cập Nhật Đơn Hàng</button>
            <a href="/order-list" class="btn btn-secondary">Trở lại Danh Sách Đơn Hàng</a>
        </div>
    </form>
</div>

<script>
function updateProductRow(input) {
    const row = input.closest('tr');
    const quantity = parseInt(input.value) || 0;
    const price = parseFloat(row.querySelector('input[name^="product_price_"]').value) || 0;

    // Update total price for the current product
    const totalField = row.querySelector('input[name^="product_total_"]');
    totalField.value = (quantity * price).toFixed(2); // Update total for this product

    // Update overall total price
    updateTotalPrice();
}

function updateTotalPrice() {
    const totalPriceField = document.getElementById('total_price');
    const productRows = document.querySelectorAll('#product-rows tr');
    let total = 0;

    productRows.forEach(row => {
        const totalField = row.querySelector('input[name^="product_total_"]');
        total += parseFloat(totalField.value) || 0; // Sum up all product totals
    });

    totalPriceField.value = total.toFixed(2); // Update the overall total price
}

function removeProductRow(button) {
    const row = button.closest('tr');
    row.remove();
    updateTotalPrice(); // Recalculate total price after removing a row
}
</script>

{% endblock %}
